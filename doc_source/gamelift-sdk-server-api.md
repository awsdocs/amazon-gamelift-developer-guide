# Add GameLift to your game server<a name="gamelift-sdk-server-api"></a>

Your custom game server must communicate with Amazon GameLift, because each game server process must be able to respond to events that GameLift starts\. Your game server must also keep GameLift informed about the server process status and player connections\. For more information about how your game server, backend service, game client, and GameLift work together to manage game hosting, see [GameLift and game client server interactions](gamelift-sdk-interactions.md)\.

To prepare your game server to interact with GameLift, add the GameLift Server SDK to your game server project and build in the functionality described in this topic\. The Server SDK is available in several languages\. For more information about the GameLift Server SDK, see [Download Amazon GameLift SDKs](gamelift-supported.md)\.

Server SDK API references:
+ [GameLift server API 5\.x reference for C\+\+](integration-server-sdk5-cpp.md)
+ [GameLift server API 5\.x reference for C\#](integration-server-sdk5-csharp.md)
+ [GameLift server API reference for Unreal Engine](integration-server-sdk-unreal-ref.md)

## Initialize the server process<a name="gamelift-sdk-server-initialize"></a>

Add code to establish communication with GameLift and to report that the server process is ready to host a game session\. This code must run before any GameLift code\.

1. Initialize GameLift API client by calling `InitSdk()`\. To initialize a server process on a GameLift Anywhere compute resource, call `InitSdk()` with the following `ServerParameters`:
   + The URL of the websocket used to connect to your game server\.
   + The ID of the process used to host your game server\.
   + The ID of the compute hosting your game server processes\.
   + The ID of the GameLift fleet containing your GameLift Anywhere compute\.
   + The authorization token generated by the GameLift operation `[GetComputeAuthToken](https://docs.aws.amazon.com/gamelift/latest/apireference/API_GetComputeAuthToken.html)`\.

1. Notify GameLift that a server process is ready to host a game session\. Call `ProcessReady()` \([C\#](integration-server-sdk5-csharp-actions.md#integration-server-sdk5-csharp-processready)\) \([C\+\+](integration-server-sdk5-cpp-actions.md#integration-server-sdk5-cpp-processready)\) \([Unreal](integration-server-sdk-unreal-ref-actions.md#integration-server-sdk-unreal-ref-processready)\) with the following information\. \(Note that you should call `ProcessReady()` only once per server process\)\.
   + The port number that the server process uses\. The backend service provides the port number and an IP address to game clients to connect to the server process and join a game session\.
   + The location of files, such as game session logs, that you want GameLift to retain\. The server process generates these files during a game session\. They're temporarily stored on the instance where the server process is running, and they're lost when the instance shuts down\. Any files that you list are uploaded to GameLift\. You can access these files through the [GameLift console](https://console.aws.amazon.com/gamelift) or by calling the GameLift API operation [GetGameSessionLogUrl\(\)](https://docs.aws.amazon.com/gamelift/latest/apireference/API_GetGameSessionLogUrl.html)\.
   + The names of callback functions that GameLift can call to your server process\. Your game server must implement these functions\. For more information, see [ProcessParameters](integration-server-sdk5-cpp-datatypes.md#integration-server-sdk5-cpp-dataypes-process)\.
     + \(Optional\) `onHealthCheck` – GameLift calls this function regularly to request a health status report from the server\.
     + `onStartGameSession` – GameLift calls this function in response to the client request [CreateGameSession\(\)](https://docs.aws.amazon.com/gamelift/latest/apireference/API_CreateGameSession.html)\.
     + `onProcessTerminate` – GameLift forces the server process to stop, letting it shut down gracefully\.
     + \(Optional\) `onUpdateGameSession` – GameLift delivers an updated game session object to the game server or provides a status update on a match backfill request\. The [FlexMatch backfill](https://docs.aws.amazon.com/gamelift/latest/flexmatchguide/match-backfill.html) feature requires this callback\.

   You can also set up a game server to securely access AWS resources that you own or control\. For more information, see [Communicate with other AWS resources from your fleets](gamelift-sdk-server-resources.md)\.

## \(Optional\) Report server process health<a name="gamelift-sdk-server-health"></a>

Add code to your game server to implement the callback function `onHealthCheck()`\. GameLift invokes this callback method periodically to collect health metrics\. To implement this callback function, do the following:
+ Evaluate the health status of the server process\. For example, you might report the server process as unhealthy if any external dependencies have failed\.
+ Complete the health evaluation and respond to the callback within 60 seconds\. If GameLift doesn't receive a response in that time, it automatically considers the server process to be unhealthy\.
+ Return a Boolean value: true for healthy, false for unhealthy\.

If you don't implement a health check callback, then GameLift considers the server process to be healthy unless the server doesn't respond\.

GameLift uses server process health to end unhealthy processes and clear up resources\. If a server process continues to report as unhealthy or doesn't respond for three consecutive health checks, then GameLift might shut down the process and start a new one\. GameLift collects metrics on a fleet's server process health\.

## \(Optional\) Get a TLS certificate<a name="gamelift-sdk-server-getcertificate"></a>

If the server process is running on a fleet that has TLS certificate generation activated, then you can retrieve the TLS certificate to establish a secure connection with a game client and to encrypt client server communication\. A copy of the certificate is stored on the instance\. To get the file location, call `GetComputeCertificate()` \([C\#](integration-server-sdk5-csharp-actions.md#integration-server-sdk5-csharp-getcomputertificate)\) \([C\+\+](integration-server-sdk5-cpp-actions.md#integration-server-sdk5-cpp-getcomputertificate)\)\.

## Start a game session<a name="gamelift-sdk-server-startsession"></a>

Add code to implement the callback function `onStartGameSession`\. GameLift invokes this callback to start a game session on the server\.

The `onStartGameSession` function takes a [GameSession](https://docs.aws.amazon.com/gamelift/latest/apireference/API_GameSession.html) object as an input parameter\. This object includes key game session information, such as maximum players\. It can also include game data and player data\. The function implementation should do the following tasks:
+ Initiate actions to create a new game session based on the `GameSession` properties\. At minimum, the game server must associate the game session ID, which game clients reference when connecting to the server process\.
+ Process game data and player data as needed\. This data is in the `GameSession` object\.
+ Notify GameLift when a new game session is ready to accept players\. Call the server API operation `ActivateGameSession()` \([C\#](integration-server-sdk5-csharp-actions.md#integration-server-sdk5-csharp-activategamesession)\) \([C\+\+](integration-server-sdk5-cpp-actions.md#integration-server-sdk5-cpp-activategamesession)\) \([Unreal](integration-server-sdk-unreal-ref-actions.md#integration-server-sdk-unreal-ref-activategamesession)\)\. In response to a successful call, GameLift changes the game session status to `ACTIVE`\.

## \(Optional\) Validate a new player<a name="gamelift-sdk-server-validateplayer"></a>

If you're tracking the status of player sessions, then add code to validate a new player when they connect to a game server\. GameLift tracks current players and available game session slots\.

For validation, a game client requesting access to the game session must include a player session ID\. GameLift automatically generates this ID when a player asks to join a game using [StartGameSessionPlacement\(\)](https://docs.aws.amazon.com/gamelift/latest/apireference/API_StartGameSessionPlacement.html) or [StartMatchmaking\(\)](https://docs.aws.amazon.com/gamelift/latest/apireference/API_StartMatchmaking.html)\. The player session then reserves an open slot in a game session\.

When the game server process receives a game client connection request, it calls `AcceptPlayerSession()` \([C\#](integration-server-sdk5-csharp-actions.md#integration-server-sdk5-csharp-acceptplayersession)\) \([C\+\+](integration-server-sdk5-cpp-actions.md#integration-server-sdk5-cpp-acceptplayersession)\) \([Unreal](integration-server-sdk-unreal-ref-actions.md#integration-server-sdk-unreal-ref-acceptplayersession)\) with the player session ID\. In response, GameLift verifies that the player session ID corresponds to an open slot reserved in the game session\. After GameLift validates the player session ID, the server process accepts the connection\. The player can then join the game session\. If GameLift doesn't validate the player session ID, then the server process denies the connection\.

## \(Optional\) Report a player session ending<a name="gamelift-sdk-server-droppedplayer"></a>

If you're tracking the status of player sessions, then add code to notify GameLift when a player leaves the game session\. This code should run whenever the server process detects a dropped connection\. GameLift uses this notification to track current players and available slots in the game session\.

To handle dropped connections, in your code, add a call to the server API operation `RemovePlayerSession()` \([C\#](integration-server-sdk5-csharp-actions.md#integration-server-sdk5-csharp-removeplayersession)\) \([C\+\+](integration-server-sdk5-cpp-actions.md#integration-server-sdk5-cpp-removeplayersession)\) \([Unreal](integration-server-sdk-unreal-ref-actions.md#integration-server-sdk-unreal-ref-removeplayersession)\) with the corresponding player session ID\.

## End a game session<a name="gamelift-sdk-server-shutdownsession"></a>

Add code to the server process shutdown sequence to notify GameLift when a game session is ending\. To recycle and refresh hosting resources, GameLift shuts down server processes after the game session is complete\.

At the start of the server process shutdown code, call the server API operation `ProcessEnding()` \([C\#](integration-server-sdk5-csharp-actions.md#integration-server-sdk5-csharp-processending)\) \([C\+\+](integration-server-sdk5-cpp-actions.md#integration-server-sdk5-cpp-processending)\) \([Unreal](integration-server-sdk-unreal-ref-actions.md#integration-server-sdk-unreal-ref-processending)\)\. This call notifies GameLift that the server process is shutting down\. GameLift changes the game session status and server process status to `TERMINATED`\. After calling `ProcessEnding()`, it's safe for the process to shut down\.

## Respond to a server process shutdown notification<a name="gamelift-sdk-server-terminate"></a>

Add code to shut down the server process in response to a notification from GameLift\. GameLift sends this notification when the server process consistently reports unhealthy, or if the instance where the server process is running is being terminated\. GameLift can stop an instance as part of a capacity scale\-down event, or in response to Spot Instance interruption\.

To handle a shutdown notification, make the following changes to your game server code:
+ Implement the callback function `onProcessTerminate()`\. This function should call the code that shuts down the server process\. When GameLift invokes this operation, Spot Instance interruptions provide a two\-minute notice\. This notice gives the server process time to disconnect players gracefully, preserve game state data, and perform other cleanup tasks\.
+ Call the server API operation `GetTerminationTime()` \([C\#](integration-server-sdk5-csharp-actions.md#integration-server-sdk5-csharp-getterm)\) \([C\+\+](integration-server-sdk5-cpp-actions.md#integration-server-sdk5-cpp-getterm)\) from your game server shutdown code\. If GameLift has issued a call to stop the server process, then `GetTerminationTime()` returns the estimated termination time\.
+ At the start of your game server shutdown code, call the server API operation `ProcessEnding()` \([C\#](integration-server-sdk5-csharp-actions.md#integration-server-sdk5-csharp-processending)\) \([C\+\+](integration-server-sdk5-cpp-actions.md#integration-server-sdk5-cpp-processending)\) \([Unreal](integration-server-sdk-unreal-ref-actions.md#integration-server-sdk-unreal-ref-processending)\)\. This call notifies GameLift that the server process is shutting down, and GameLift then changes the server process status to `TERMINATED`\. After calling `ProcessEnding()`, it's safe for the process to shut down\.